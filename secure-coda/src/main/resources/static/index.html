<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SecureCoda | Security Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; }
        .severity-HIGH { background-color: #ffe6e6; color: #cc0000; font-weight: bold; }
        .severity-MEDIUM { background-color: #fff3cd; color: #856404; }
        .severity-LOW { background-color: #d4edda; color: #155724; }
    </style>
</head>
<body>

<nav class="navbar navbar-dark bg-dark">
    <div class="container-fluid">
        <span class="navbar-brand mb-0 h1">üõ°Ô∏è SecureCoda Monitor</span>
        <button class="btn btn-primary btn-sm" onclick="triggerScan()">Run Security Scan Now</button>
    </div>
</nav>

<div class="container mt-4">
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card text-center">
                <div class="card-body">
                    <h5 class="card-title">Total Alerts</h5>
                    <p class="card-text display-6" id="total-count">0</p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card text-center text-danger">
                <div class="card-body">
                    <h5 class="card-title">High Severity</h5>
                    <p class="card-text display-6" id="high-count">0</p>
                </div>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-header bg-white">
            <strong>Active Security Alerts</strong>
            <button class="btn btn-sm btn-outline-secondary float-end" onclick="loadAlerts()">Refresh List</button>
        </div>
        <div class="card-body p-0">
            <table class="table table-hover mb-0">
                <thead class="table-light">
                <tr>
                    <th>Severity</th>
                    <th>Type</th>
                    <th>Document Name</th>
                    <th>Description</th>
                    <th>Detected At</th>
                    <th>Action</th>
                </tr>
                </thead>
                <tbody id="alerts-table-body">
                <tr><td colspan="6" class="text-center p-3">Loading alerts...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    // 1. Fetch alerts when page loads
    document.addEventListener('DOMContentLoaded', loadAlerts);

    function loadAlerts() {
        fetch('/api/alerts')
            .then(response => response.json())
            .then(data => {
                const tableBody = document.getElementById('alerts-table-body');
                let highCount = 0;

                tableBody.innerHTML = ''; // Clear loading message

                if (data.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="6" class="text-center p-3">‚úÖ No active security threats found.</td></tr>';
                    updateStats(0, 0);
                    return;
                }

                data.forEach(alert => {
                    if (alert.severity === 'HIGH') highCount++;

                    const row = `
                        <tr>
                            <td><span class="badge severity-${alert.severity}">${alert.severity}</span></td>
                            <td>${alert.alertType}</td>
                            <td><strong>${alert.docName}</strong></td>
                            <td class="text-muted small">${alert.description}</td>
                            <td>${new Date(alert.detectedAt).toLocaleString()}</td>
                            <td>
                                <button class="btn btn-sm btn-outline-danger" onclick="fixIssue(${alert.id})">Fix</button>
                            </td>
                        </tr>
                    `;
                    tableBody.innerHTML += row;
                });

                updateStats(data.length, highCount);
            })
            .catch(error => console.error('Error fetching alerts:', error));
    }

    function triggerScan() {
        const btn = document.querySelector('.btn-primary');
        btn.innerHTML = 'Scanning...';
        btn.disabled = true;

        fetch('/api/scan/trigger', { method: 'POST' })
            .then(response => {
                if (response.ok) {
                    alert("Scan started successfully!");
                    // Wait 2 seconds for scan to finish (simple hack) then refresh
                    setTimeout(() => {
                        loadAlerts();
                        btn.innerHTML = 'Run Security Scan Now';
                        btn.disabled = false;
                    }, 2000);
                }
            });
    }

    function updateStats(total, high) {
        document.getElementById('total-count').innerText = total;
        document.getElementById('high-count').innerText = high;
    }

    function fixIssue(id) {
        if (!confirm("Are you sure you want to fix this issue? This might delete data on Coda.")) {
            return;
        }

        // Find the button and change text
        const btn = event.target; // Simple way to grab the clicked button
        const originalText = btn.innerText;
        btn.innerText = "Fixing...";
        btn.disabled = true;

        fetch(`/api/alerts/${id}/remediate`, { method: 'POST' })
            .then(response => {
                if (response.ok) {
                    alert("‚úÖ Issue resolved successfully!");
                    loadAlerts(); // Refresh the table to show it's gone
                } else {
                    alert("‚ùå Failed to remediate. Check server logs.");
                    btn.innerText = originalText;
                    btn.disabled = false;
                }
            })
            .catch(err => {
                console.error(err);
                alert("Error connecting to server.");
                btn.innerText = originalText;
                btn.disabled = false;
            });
    }
</script>

</body>
</html>